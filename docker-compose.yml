services:
  web:
    build: .
    environment:
      MONGO_URI: mongodb://mongo:27017
      MONGO_DB: TestePy
      MONGO_COLLECTION: search_cache
      DOTNET_BASE_URL: http://catalogoservice:80
      CACHE_TTL_MINUTES: 10
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "8000"
    volumes:
      - ./:/app
    restart: unless-stopped
    networks:
      - repo-ref-network

  # Auto-register all servicopesquisa instances with Consul
  servicopesquisa-register:
    image: curlimages/curl:latest
    depends_on:
      web:
        condition: service_started
    networks:
      - repo-ref-network
    environment:
      - CONSUL_ADDR=http://consul:8500
    command: 
      - sh
      - -c
      - |
        while true; do
          # Try to register instances 1-100 (practical upper limit for auto-discovery)
          for i in $$(seq 1 100); do
            container="servicopesquisa-web-$$i"
            IP=$$(getent hosts $$container 2>/dev/null | awk '{print $$1}' | head -1)
            if [ -n "$$IP" ]; then
              curl -X PUT http://consul:8500/v1/agent/service/register \
              -H "Content-Type: application/json" \
              -d "{\"ID\":\"$$container\",\"Name\":\"servico-busca\",\"Address\":\"$$IP\",\"Port\":8000,\"Tags\":[\"api\",\"search\"]}" 2>/dev/null || true
            fi
          done
          sleep 30
        done
    restart: always

  mongo:
    image: mongo:7
    container_name: search_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped
    networks:
      - repo-ref-network

volumes:
  mongo_data:

networks:
  repo-ref-network:
    external: true
